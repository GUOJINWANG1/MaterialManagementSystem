<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Material Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }
        .container {
            display: grid;
            grid-template-columns: 30% 70%;
            width: 100%;
            height: 100vh;
        }
        h2 {
            grid-column: span 2;
            text-align: center;
            color: #333;
            margin-top: 20px;
        }
        form {
            width: 400px;
            height: 800px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            border: 1px solid #000;
            overflow-y: auto;
        }
        form label {
            display: block;
            font-weight: bold;
            margin-top: 10px;
        }
        form input, form select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #000;
            border-radius: 4px;
        }
        form button {
            width: 100%;
            padding: 10px;
            background-color: #000;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin-top: 20px;
        }
        form button:hover {
            background-color: #218838;
        }
        .product-list {
            padding: 20px;
            overflow: hidden;
        }
        .product-list table {
            width: calc(100% - 40px);
            margin-left: 20px;
            border-collapse: collapse;
            text-align: center;
            table-layout: fixed;
        }
        .product-list th, .product-list td {
            border: 1px solid #000;
            padding: 8px;
            word-wrap: break-word;
        }
        .product-list th {
            cursor: pointer;
            background-color: #f4f4f9;
        }
        .product-list .expired {
            background-color: red;
            color: white;
        }
        .product-list .expiring-soon {
            background-color: yellow;
        }
        .product-list .valid {
            background-color: lightgreen;
        }
        .actions button {
            background-color: #000;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin: 2px;
        }
        .actions button:hover {
            background-color: #218838;
        }
        .pagination {
            margin: 10px;
            text-align: center;
        }
        .pagination button {
            background-color: #000;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin: 2px;
        }
        .pagination button:hover {
            background-color: #218838;
        }
        #searchBar {
            width: calc(100% - 60px);
            padding: 8px;
            margin: 20px;
            border: 1px solid #000;
            border-radius: 4px;
            float: right;
        }
        #exportBtn, #importBtn {
            background-color: #000;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin: 10px;
            float: right;
        }
        #exportBtn:hover, #importBtn:hover {
            background-color: #218838;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        /* Confirmation Dialog */
        .confirmation {
            display: none;
            background-color: rgba(0,0,0,0.8);
            color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
        .confirmation button {
            background-color: #000;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin: 10px;
        }
        .confirmation button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Column -->
        <div>
            <form id="productForm">
                <label for="scanQR">Scan QR Code:</label>
                <input type="text" id="scanQR" placeholder="Scan QR Code here..." oninput="handleQRInput()">
                <label for="productID">Product ID (Required):</label>
                <input type="text" id="productID" required>
                <label for="productType">Product Type (Required):</label>
                <input type="text" id="productType" required>
                <label for="productBatchID">Product Batch ID (Required):</label>
                <input type="text" id="productBatchID" required>
                <label for="quantity">Quantity (1-50000, Required):</label>
                <input type="number" id="quantity" min="1" max="50000" required>
                <label for="productionTime">Production Time (MM/DD/YYYY):</label>
                <input type="text" id="productionTime" placeholder="MM/DD/YYYY" required>
                <label for="username">User (Optional):</label>
                <input type="text" id="username">
                <label for="location">Location (Optional):</label>
                <input type="text" id="location">
                <button type="button" onclick="addProduct()">Add Product</button>
            </form>
        </div>
        <!-- Right Column -->
        <div>
            <h2>Material Management System</h2>
            <input type="text" id="searchBar" placeholder="Search..." oninput="searchProducts()">
            <button id="exportBtn" onclick="exportToCSV()">Export</button>
            <button id="importBtn" onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importFromCSV(event)">
            <div class="product-list">
                <table id="productList">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                            <th onclick="sortTable(1)">Product ID &#9650;&#9660;</th>
                            <th onclick="sortTable(2)">Product Type &#9650;&#9660;</th>
                            <th onclick="sortTable(3)">Quantity &#9650;&#9660;</th>
                            <th onclick="sortTable(4)">Expiration Time &#9650;&#9660;</th>
                            <th>Product Batch ID</th>
                            <th>User</th>
                            <th>Location</th>
                            <th>Added Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Product rows will be added here -->
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
            <button type="button" onclick="deleteSelectedProducts()">Delete Selected Products</button>
        </div>
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Edit Product</h3>
            <label for="editProductID">Product ID:</label>
            <input type="text" id="editProductID" readonly>
            <label for="editProductType">Product Type:</label>
            <input type="text" id="editProductType">
            <label for="editProductBatchID">Product Batch ID:</label>
            <input type="text" id="editProductBatchID">
            <label for="editQuantity">Quantity:</label>
            <input type="number" id="editQuantity" min="1" max="50000">
            <label for="editExpiration">Production Time (MM/DD/YYYY):</label>
            <input type="text" id="editExpiration" placeholder="MM/DD/YYYY">
            <label for="editUser">User:</label>
            <input type="text" id="editUser">
            <label for="editLocation">Location:</label>
            <input type="text" id="editLocation">
            <button type="button" onclick="saveEdit()">Save Changes</button>
        </div>
    </div>
    <!-- Confirmation Dialog -->
    <div class="confirmation" id="confirmation">
        <p>Are you sure you want to proceed?</p>
        <button onclick="confirmAction()">Yes</button>
        <button onclick="cancelAction()">No</button>
    </div>
    <script>
        let products = JSON.parse(localStorage.getItem('products')) || [];

let selectedProducts = [];

let currentEditIndex = -1;

let currentPage = 1;

const itemsPerPage = 15;

// 当页面加载时，从 localStorage 获取产品数据

window.onload = function() {

    const storedProducts = localStorage.getItem('products');

    if (storedProducts) {

        products = JSON.parse(storedProducts);

    } else {

        products = [];  // 如果没有数据，初始化为空数组

    }

    updateProductList();  // 更新产品列表显示

};

// 以下是其他功能函数

function handleQRInput() {

    const qrData = document.getElementById("scanQR").value;

    const parsedData = parseQRCode(qrData);

    if (parsedData) {

        document.getElementById("productID").value = parsedData.productID;

        document.getElementById("productType").value = parsedData.productType;

        document.getElementById("quantity").value = parsedData.quantity;

        document.getElementById("productionTime").value = parsedData.productionTime;

        document.getElementById("productBatchID").value = parsedData.productBatchID;

        addProduct();

    }

}

function parseQRCode(qrData) {

    const parts = qrData.split('|');

    if (parts.length < 7) {

        alert("Invalid QR code format.");

        return null;

    }

    // Extract and clean data

    let productType = parts[0].replace(/^P/, '');

    let supplierID = parts[1].replace(/^1P/, '');

    let productBatchID = parts[2].replace(/^1T/, '');

    let quantityStr = parts[3].replace(/^7Q/, '').replace('+EA', '');

    let quantity = parseInt(quantityStr, 10);

    let productID = parts[4].replace(/^S/, '');

    let supplier = parts[5].replace(/^21P/, '');

    let productionDateStr = parts[6].replace(/^9D/, '');

    let productionTime = formatDate(productionDateStr);

    if (isNaN(quantity) || !productionTime) {

        alert("Invalid data in QR code.");

        return null;

    }

    return {

        productID,

        productType,

        quantity,

        productionTime,

        productBatchID

    };

}
 
        function formatDate(dateString) {
            if (dateString.length !== 8) {
                console.error("Invalid date format");
                return null;
            }
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${month}/${day}/${year}`;
        }

        function addProduct() {
            const productID = document.getElementById("productID").value.trim();
            const productType = document.getElementById("productType").value.trim();
            const quantity = parseInt(document.getElementById("quantity").value, 10);
            const productionTime = document.getElementById("productionTime").value.trim();
            const productBatchID = document.getElementById("productBatchID").value.trim();
            const username = document.getElementById("username").value.trim();
            const location = document.getElementById("location").value.trim();
            const currentDate = new Date();
            const addedDate = `${currentDate.getMonth() + 1}/${currentDate.getDate()}/${currentDate.getFullYear()}`;

            if (!productID || !productType || !productBatchID || !productionTime) {
                alert("All required fields must be filled!");
                return;
            }

            if (quantity < 1 || quantity > 50000) {
                alert("Quantity must be between 1 and 50000.");
                return;
            }

            // Calculate expiration date
            const prodDateParts = productionTime.split('/');
            const prodDate = new Date(`${prodDateParts[2]}-${prodDateParts[0]}-${prodDateParts[1]}`);
            if (isNaN(prodDate)) {
                alert("Invalid production date.");
                return;
            }
            const expirationDate = new Date(prodDate.setFullYear(prodDate.getFullYear() + 2));
            const expirationTime = `${expirationDate.getMonth() + 1}/${expirationDate.getDate()}/${expirationDate.getFullYear()}`;

            products.unshift({
                productID,
                productType,
                quantity,
                expirationTime,
                productBatchID,
                username,
                location,
                addedDate
            });
            updateProductList();
            saveToLocalStorage();
            clearFormFields();
        }

        function clearFormFields() {
            document.getElementById("scanQR").value = "";
            document.getElementById("productID").value = "";
            document.getElementById("productType").value = "";
            document.getElementById("quantity").value = "";
            document.getElementById("productionTime").value = "";
            document.getElementById("productBatchID").value = "";
        }

   function updateProductList() {
   const tbody = document.querySelector("#productList tbody");
   tbody.innerHTML = "";
   // 过滤产品
   const filteredProducts = products.filter(filterProducts);
   // 计算总页数
   const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
   // 确保当前页面没有超过总页数
   currentPage = Math.min(currentPage, totalPages);
   // 确保如果产品不足15条，自动移动到上一页
   if (filteredProducts.length > 0 && currentPage > totalPages) {
       currentPage = totalPages;
   }
   const start = (currentPage - 1) * itemsPerPage;
   const end = start + itemsPerPage;
   const pageProducts = filteredProducts.slice(start, end);
   // 如果没有产品，隐藏分页
   if (filteredProducts.length === 0) {
       document.getElementById("pagination").style.display = "none";
   } else {
       document.getElementById("pagination").style.display = "block";
   }
   // 生成每个产品的行
   pageProducts.forEach((product, index) => {
       const row = document.createElement("tr");
       const now = new Date();
       const expParts = product.expirationTime.split('/');
       const expirationDate = new Date(`${expParts[2]}-${expParts[0]}-${expParts[1]}`);
       const timeDiff = expirationDate.getTime() - now.getTime();
       const daysToExpire = Math.ceil(timeDiff / (1000 * 3600 * 24));
       // 根据产品的过期时间来确定CSS类
       let expirationClass = "";
       if (daysToExpire < 0) {
           expirationClass = "expired";
       } else if (daysToExpire <= 15) {
           expirationClass = "expiring-soon";
       } else {
           expirationClass = "valid";
       }
       // 创建产品表格行的HTML
       row.innerHTML = `
<td><input type="checkbox" class="multi-select-checkbox" value="${index + start}"></td>
<td>${product.productID}</td>
<td>${product.productType}</td>
<td>${product.quantity}</td>
<td class="${expirationClass}">${product.expirationTime}</td>
<td>${product.productBatchID}</td>
<td>${product.username}</td>
<td>${product.location}</td>
<td>${product.addedDate}</td>
<td class="actions">
<button onclick="editProduct(${index + start})">Edit</button>
<button onclick="confirmDelete(${index + start})">Delete</button>
</td>
       `;
       tbody.appendChild(row);
   });
   // 渲染分页
   renderPagination(totalPages);
}

        function saveToLocalStorage() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function editProduct(index) {
            currentEditIndex = index;
            const product = products[index];
            document.getElementById("editProductID").value = product.productID;
            document.getElementById("editProductType").value = product.productType;
            document.getElementById("editQuantity").value = product.quantity;
            document.getElementById("editExpiration").value = product.expirationTime;
            document.getElementById("editProductBatchID").value = product.productBatchID;
            document.getElementById("editUser").value = product.username;
            document.getElementById("editLocation").value = product.location;
            document.getElementById("editModal").style.display = "block";
        }

        function saveEdit() {
            const productType = document.getElementById("editProductType").value.trim();
            const quantity = parseInt(document.getElementById("editQuantity").value, 10);
            const expirationTime = document.getElementById("editExpiration").value.trim();
            const productBatchID = document.getElementById("editProductBatchID").value.trim();
            const username = document.getElementById("editUser").value.trim();
            const location = document.getElementById("editLocation").value.trim();

            if (quantity < 1 || quantity > 50000) {
                alert("Quantity must be between 1 and 50000.");
                return;
            }

            products[currentEditIndex].productType = productType;
            products[currentEditIndex].quantity = quantity;
            products[currentEditIndex].expirationTime = expirationTime;
            products[currentEditIndex].productBatchID = productBatchID;
            products[currentEditIndex].username = username;
            products[currentEditIndex].location = location;
            closeEditModal();
            updateProductList();
            saveToLocalStorage();
        }

        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
        }
function confirmDelete(index) {
   if (confirm("Are you sure you want to delete this product?")) {
       // 删除数组中的产品
       products.splice(index, 1);
       // 重新保存更新后的产品数组到 localStorage
       localStorage.setItem('products', JSON.stringify(products));
       // 更新产品列表显示
       updateProductList();
   }
}

        function deleteSelectedProducts() {
            const checkboxes = document.querySelectorAll('.multi-select-checkbox:checked');
            if (checkboxes.length === 1) {
                alert("No products selected!");
                return;
            }
            selectedProducts = Array.from(checkboxes).map(cb => parseInt(cb.value));
            document.getElementById("confirmation").style.display = "block";
        }

        function confirmAction() {
            selectedProducts.sort((a, b) => b - a);
            selectedProducts.forEach(index => {
                products.splice(index, 1);
            });
            selectedProducts = [];
            updateProductList();
            saveToLocalStorage();
            document.getElementById("confirmation").style.display = "none";
        }

        function cancelAction() {
            selectedProducts = [];
            document.getElementById("confirmation").style.display = "none";
        }

        function sortTable(colIndex) {
            const keyMap = {
                1: 'productID',
                2: 'productType',
                3: 'quantity',
                4: 'expirationTime'
            };
            const key = keyMap[colIndex];
            products.sort((a, b) => {
                if (key === 'quantity') {
                    return a[key] - b[key];
                } else if (key === 'expirationTime') {
                    return new Date(a[key]) - new Date(b[key]);
                } else {
                    return a[key].localeCompare(b[key]);
                }
            });
            updateProductList();
            saveToLocalStorage();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.multi-select-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function searchProducts() {
            currentPage = 1;
            updateProductList();
        }

        function filterProducts(product) {
            const searchQuery = document.getElementById('searchBar').value.toLowerCase();
            return Object.values(product).some(value =>
                String(value).toLowerCase().includes(searchQuery)
            );
        }

        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById("pagination");
           paginationContainer.innerHTML = "";
          if (products.length === 0) {
       paginationContainer.style.display = "none";  // Hide if no products at all
       return;
   } else {
       paginationContainer.style.display = "block";  // Show pagination if products exist
   }
   for (let i = 1; i <= totalPages; i++) {
       const button = document.createElement("button");
       button.textContent = i;
       if (i === currentPage) {
           button.classList.add("active");
       }
       button.addEventListener("click", () => {
           currentPage = i;
           updateProductList();
       });
       paginationContainer.appendChild(button);
   }
}

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Product ID", "Product Type", "Quantity", "Expiration Time", "Product Batch ID", "User", "Location", "Added Date"];
            csvContent += headers.join(",") + "\r\n";
            products.forEach(product => {
                const row = [product.productID, product.productType, product.quantity, product.expirationTime, product.productBatchID, product.username, product.location, product.addedDate];
                csvContent += row.join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "products.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                lines.shift(); // Remove header
                lines.forEach(line => {
                    const data = line.split(',');
                    if (data.length >= 8) {
                        products.push({
                            productID: data[0],
                            productType: data[1],
                            quantity: parseInt(data[2], 10),
                            expirationTime: data[3],
                            productBatchID: data[4],
                            username: data[5],
                            location: data[6],
                            addedDate: data[7].trim()
                        });
                    }
                });
                updateProductList();
                saveToLocalStorage();
            };
            reader.readAsText(file);
        }

        // Initialize
        updateProductList();
        
    </script>
</body>
</html>
